<%- include('./partials/header') %>

<div class="w-full min-h-screen flex flex-col gap-10 px-20 py-20 bg-gray-100">

  <% if (user.cart && user.cart.length > 0) { %>
    <div id="cart-container" class="flex flex-col gap-8">

      <% user.cart.forEach(function(product, index) { %>
        <% let qty = product.quantity || 1; %>
        <% let totalMRP = Number(product.price) * qty; %>
        <% let discount = Number(product.discount || 0); %>
        <% let platformFee = 20; %>
        <% let shippingFee = 0; %>
        <% let subtotal = totalMRP - discount + platformFee + shippingFee; %>

        <!-- Product Row -->
        <div class="w-full flex flex-col md:flex-row items-start gap-10 bg-white p-5 rounded-md shadow-md product-item"
             data-price="<%= product.price %>" data-discount="<%= product.discount || 0 %>">

          <!-- Left: Product Image -->
          <div class="w-full md:w-[30%] rounded-md overflow-hidden border flex items-center justify-center bg-gray-100 h-80">
            <% if (product.image) { %>
              <% if (typeof product.image === "string") { %>
                <img src="<%= product.image %>" alt="<%= product.name %>" class="object-contain w-full h-full">
              <% } else { %>
                <img src="data:image/jpeg;base64,<%= product.image.toString('base64') %>" 
                     alt="<%= product.name %>" class="object-contain w-full h-full">
              <% } %>
            <% } else { %>
              <span class="text-gray-400">No Image</span>
            <% } %>
          </div>

          <!-- Right: Product Description + Price -->
          <div class="w-full md:w-[70%] flex flex-col gap-4">
            <!-- Product Title + Quantity -->
            <div class="flex justify-between items-center">
              <h3 class="text-2xl font-semibold"><%= product.name %></h3>
              <div class="flex items-center gap-2">
                <button class="w-7 h-7 bg-gray-100 flex rounded-full items-center justify-center decrement">-</button>
                <div class="px-2 py-1 rounded-md bg-gray-100 text-black quantity"><%= qty %></div>
                <button class="w-7 h-7 bg-gray-100 flex rounded-full items-center justify-center increment">+</button>
              </div>
            </div>

            <!-- Price Breakdown -->
            <div class="flex flex-col gap-1 text-sm border p-4 rounded-md bg-gray-50">
              <div class="flex justify-between">
                <span>Total MRP</span>
                <span>â‚¹ <%= totalMRP %></span>
              </div>
              <div class="flex justify-between">
                <span>Discount</span>
                <span>- â‚¹ <%= discount %></span>
              </div>
              <div class="flex justify-between">
                <span>Platform Fee</span>
                <span>â‚¹ <%= platformFee %></span>
              </div>
              <div class="flex justify-between">
                <span>Shipping Fee</span>
                <span><%= shippingFee === 0 ? 'FREE' : 'â‚¹ ' + shippingFee %></span>
              </div>
              <div class="flex justify-between font-semibold mt-2">
                <span>Subtotal</span>
                <span class="subtotal">â‚¹ <%= subtotal %></span>
              </div>
            </div>

            <!-- Buy Now Button -->
            <div>
              <button class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 buy-now">Buy Now</button>
            </div>
          </div>

        </div>
      <% }) %>

    </div>

    <!-- Grand Total -->
    <div class="w-full bg-white p-6 mt-8 rounded-lg shadow-md flex justify-between items-center">
      <h2 class="text-2xl font-bold">Grand Total</h2>
      <h2 id="grand-total" class="text-2xl font-bold text-green-600">â‚¹ 0</h2>
    </div>

  <% } else { %>
    <div class="text-center py-20">
      <h2 class="text-2xl font-bold text-gray-600">Your cart is empty ðŸ›’</h2>
    </div>
  <% } %>

</div>

<script>
  function updateTotals() {
    let grandTotal = 0;
    document.querySelectorAll('.product-item').forEach(item => {
      let price = Number(item.dataset.price);
      let discount = Number(item.dataset.discount);
      let qty = Number(item.querySelector('.quantity').innerText);
      let subtotal = (price * qty - discount) + 20; // platform fee
      item.querySelector('.subtotal').innerText = "â‚¹ " + subtotal;
      grandTotal += subtotal;
    });
    document.getElementById('grand-total').innerText = "â‚¹ " + grandTotal;
  }

  document.querySelectorAll('.increment').forEach(btn => {
    btn.addEventListener('click', e => {
      let qtyEl = e.target.closest('.product-item').querySelector('.quantity');
      qtyEl.innerText = Number(qtyEl.innerText) + 1;
      updateTotals();
    });
  });

  document.querySelectorAll('.decrement').forEach(btn => {
    btn.addEventListener('click', e => {
      let qtyEl = e.target.closest('.product-item').querySelector('.quantity');
      if (Number(qtyEl.innerText) > 1) {
        qtyEl.innerText = Number(qtyEl.innerText) - 1;
        updateTotals();
      }
    });
  });

  // Initial total calculation
  updateTotals();

  // Buy Now button click
  document.querySelectorAll('.buy-now').forEach(btn => {
    btn.addEventListener('click', e => {
      alert('Redirecting to checkout for this product!');
      // window.location.href = `/checkout/${productId}`;
    });
  });
</script>

<%- include('./partials/footer') %>